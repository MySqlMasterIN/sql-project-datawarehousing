








-- create dimension customer and rename the columns in dimension table --

create VIEW gold.dim_customers AS
select 
       row_number() over(order by cst_id) as customer_key, -- surrogate key in order to connect our data model --
       silver.crm_cust_info.cst_id as customer_id,
       silver.crm_cust_info.cst_key as customer_number,
       cst_firstname as firstname,
       cst_lastname as lastname,
       cntry as country,
       cst_marital_status as marital_status,
       case when cst_gndr != 'n/a' then cst_gndr -- CRM is the master data for gender so we will choose gender from CRM (data integration) --
            else isnull(gen, 'n/a')
       END as gender,
       bdate as birthdate,
       cst_create_date as create_date
FROM silver.crm_cust_info
left join silver.erp_cust_az12 on silver.crm_cust_info.cst_key = silver.erp_cust_az12.cid
left join silver.erp_loc_a101 on silver.crm_cust_info.cst_key = silver.erp_loc_a101.cid;


-- create dimension products and rename the column name in dimension table --

select * from silver.crm_prd_info;
select * from silver.erp_px_cat_g1v2;
select * from bronze.erp_px_cat_g1v2

create view gold.dim_products as
select 
    row_number() over(order by prd_start_date, prd_key) as product_key,
    prd_id as product_id,
    prd_key as product_number,
    prd_nm as product_name,
    cat_id as category_id,
    isnull(cat,'n/a') as category,
    isnull(subcat, 'n/a') as subcategory,
    isnull(maintenance, 'n/a') as maintenance,
    prd_cost as cost,
    prd_line as product_line,
    prd_start_date as start_date
from silver.crm_prd_info
left join silver.erp_px_cat_g1v2 on silver.crm_prd_info.cat_id = silver.erp_px_cat_g1v2.id
where prd_end_date is NULL; -- filter all historical data --

drop view gold.dim_products


-- create dimension sales and rename the column name in dimension table --

select * from silver.crm_sales_details;
select * from gold.dim_customers;
select * from gold.dim_products;


create view gold.fact_sales as 
SELECT  
    sls_ord_num as order_number,
    product_key,
    customer_key,
    sls_order_dt as order_date,
    sls_ship_dt as ship_date,
    sls_due_dt as due_date,
    sls_sales as sales,
    sls_quantity as quantity,
    sls_price as price
from silver.crm_sales_details
left join gold.dim_products on silver.crm_sales_details.sls_prd_key = gold.dim_products.product_number
left join gold.dim_customers on silver.crm_sales_details.sls_cust_id = gold.dim_customers.customer_id;


